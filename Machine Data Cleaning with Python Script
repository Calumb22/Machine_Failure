# %%
# Importing relevant packages and dataset 
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

df = pd.read_csv(r"C:\Users\CalumBrown\OneDrive - Blend 360\Documents\Personal Development\Machine Learning Interview\Machine Failure Dataset.csv")


# %%
# Dataset with 10,000 rows
# 100 null values in rotational speed column which will need to be fixed
# Timestamp is a string variable which may need changed 
df.info()


# %%
# Air temperature quite a drop from 25% quartile value to minimum, wil explore this further later
# Target appears to be a binary variable 
# High variation and standard deviation in rotational speeed column 
df.describe()


# %%
df.nunique()

# %%
# Going column by column checking for mistakes and devloping under
# UID column 
# 10,000 unique values sugesting its some sort of identifier for each machine reading 
# Checking to see if any correlation between machine type and UID values 
# X!,x_1,x1 all start with a designted later - X2 appears random

uidtest = df.filter(items = ['UID', 'Machine Type'])

uidtest['UID Start'] = uidtest['UID'].str[0]

uidtest.filter(items = ['UID Start', 'Machine Type']).drop_duplicates() \
.sort_values(by = ['UID Start'], ascending = True)


# %%
# only 100 observations of X2 - seems bizarre and needs explored further. Possible input error
uidtest.filter(items = ['UID Start', 'Machine Type', 'UID']) \
.groupby(['UID Start', 'Machine Type']).count()

# %%
## X2 observations are all from 2011 through to 2013 but i beleive rest of data was from 2001 - 2003 - again possible input errors

## Try to see if other machine types are missing observations for these times
pd.set_option('display.max_rows', 200)
df.loc[df['Machine Type'] == 'X2']


# %%

# Seperating Date and timestamp 
# Will split at delimeter ' '
# Leaving original column in for now

df[['Date', 'Time']] = df['Timestamp'].str.split(' ', expand = True)

## Changing data types

df['Date'] = df['Date'].astype(dtype = 'datetime64[ns]')
df['Time'] = df['Time'].astype(dtype = 'datetime64[ns]')

# %%
# Now checking to see if days are missing 
# Dates for all other machine types are spread from 2001 - 2003, further evidence that X2 is either an input error or sperate machine tpye
# Due to having no consistent data for the X2 i am veering on side of believing it is error

df.loc[df['Machine Type'] != 'X2'].describe()


# %%
# Spot checking some of the X2 observations to see if these readings are missing from 2001-2003
# all dates of X2 are missing in 2001 - 2003.
# Why dont we have readings every hour for every machine? 
df.loc[df['Date'] == '2001-01-12']



# %%
# Converting date to string so can replace values

df['Date'] = df['Date'].astype(dtype='str')


# %%
df['Date'] = df['Date'].str.replace('2011', '2001')
df['Date'] = df['Date'].str.replace('2012', '2002')
df['Date'] = df['Date'].str.replace('2013', '2003')

df['Timestamp'] = df['Timestamp'].str.replace('2011', '2001')
df['Timestamp'] = df['Timestamp'].str.replace('2012', '2002')
df['Timestamp'] = df['Timestamp'].str.replace('2013', '2003')

# %%
# Converting X2 to correct Machine types based on UID indicator 

df.loc[df['UID'].str.startswith('H'), ['Machine Type']] = 'X1'
df.loc[df['UID'].str.startswith('M'), ['Machine Type']] = 'x1'
df.loc[df['UID'].str.startswith('L'), ['Machine Type']] = 'x_1'

# %%
# Checking failure Type column 
# dropping 'error' as no real understanding of it  - error in reading, error in machine? no clue
# Dropping 100 rows

df['Failure Type'].value_counts().sort_index()


df = df.loc[df['Failure Type'] != 'Error']

# %%
# Checking air temperature column 
# Can see a grouping of lower temperatures at around 280 - 290 kelvin, most frequent grouping around 295 - 305
# Then some extremely low temperatures which look like outliers

sns.histplot(x=df['Air temperature [K]'], kde = True)
plt.show()



# %%
# All machine types following much the same trends
sns.histplot(x=df['Air temperature [K]'], hue = df['Machine Type'], kde = True)
plt.show()



# %%
# Everything below 280 kevlin looks to be probably an outlier or error

sns.lineplot(x = df['Timestamp'], y = df['Air temperature [K]'])



# %%
# Checking that wont be removing any failure observations 
df.loc[df['Air temperature [K]'] < 280]

# %%
df.loc[df['Date'] == '2001-12-22']

# Can see that air temperature suddenly drops to 265 at 5 am from 297 at 4 am? Doesnt appear to make sense and i definetly believe these are reading errors
# Option is to fill with average or remove
# I think filling with average for that day is a good option as there is very little variation in air temperature across the days - makes sense if in a warehouse environment

df.loc[df['Date'] == '2001-12-22']



# %%
# Creating average temps for each day so can assign these values to the outliers

averagetemp = df.filter(items = ['Date', 'Air temperature [K]']) \
.groupby(['Date']).mean().reset_index()

# %%
# Creating new dataframe and fixing these air temperature outliers
df2 = df.merge(averagetemp, how = 'left', on = 'Date')
df2.loc[df2['Air temperature [K]_x'] < 280, 'Air temperature [K]_x'] = df2['Air temperature [K]_y']

# %%
# Checking to see this worked

sns.histplot(x=df2['Air temperature [K]_x'], hue = df['Machine Type'], kde = True)
plt.show()

# %%
df2 = df2.drop(columns = ['Air temperature [K]_y'])
df2 = df2.rename(columns = {'Air temperature [K]_x':'Air temperature [K]'})

# %%
# Checking for duplicates by groupingon unique columns 
df2[['Date', 'Time', 'Machine Type']] \
.groupby(by = ['Date', 'Time']).count().loc[lambda x: x['Machine Type'] > 1]

# %%
# Checking process temperature column 
# Pretty normally distributed and no outliers

sns.histplot(df2['Process temperature [K]'], kde = True)



# %%
# Rotational Speed column 
# ALso need to fix na values we observed earlier
# Couple of extreme values here - right skewed - needs explored further

sns.histplot(df2['Rotational speed [rpm]'], kde = True)



# %%
# We have alot of power failures at these high rpm's therefore going to leave as they are 
#Early suggestion that rotational speed could be a strong predictor of power failure
df2.loc[df2['Rotational speed [rpm]'] > 2250]



# %%
##Fixing na in rotational speed
## Not losing failure data so fine to just remove

df2.isnull().sum()

df2.loc[df2['Rotational speed [rpm]'].isnull()].head(100)

# %%
df2 = df2.loc[df2['Rotational speed [rpm]'].notna()]


# %%
# Tool wear column 
sns.histplot(df2['Tool wear [min]'], kde = True)

# %%
# Torque column 
# Similar plot to air temperature with a normal distribution then a seperate normal distribution 
# Quite a few high observations needing explored further
sns.histplot(df2['Torque [Nm]'])



# %%
# Going to leave this column as it is for now as dont have enough of an understanding of tool wear to detrmine if these values are outliers
df2.loc[df2['Torque [Nm]'] > 75]

# %%
# Target column 
# There is no failures in this also so do not see the point of target - will make a seperate failure variable


df2.loc[df2['Target'] == 1]

df2 = df2.drop(columns = ['Target'])


# %%
# Creating dummy failure variable in place of innacurate target variable
df2['Failure'] = 1
df2.loc[df2['Failure Type'] == 'No Failure', 'Failure'] = 0

# %%
df2['Failure Type'].value_counts()

# %%
# Dataset reading for exploratory data analysis and machine learning

df2.head()


