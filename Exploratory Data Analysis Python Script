# %%
### Exploratory Data Analysis

import numpy as np
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

machine = pd.read_csv(r"C:\Users\CalumBrown\OneDrive - Blend 360\Documents\Personal Development\Machine Learning Interview\Cleaned Machine Failure Dataset.csv", index_col=0)

# %%
machine.head()

# %%
# Looking at failure statistics
# 346 instances of failure compared to 9455 no fails
# 3.6% failure instance

sns.countplot(x = machine['Failure'])
plt.show()

print(machine['Failure'].value_counts())

print(np.round(346/9455 * 100, 2),'%')

# %%
# Checking to see differences across machine types
# Looks pretty proportional on the whole

sns.countplot(x = machine['Failure'], hue = machine['Machine Type'])
plt.show()

print(machine[['Machine Type', 'Failure']].value_counts().sort_index())


# %%
# Looking at failures by failure type - ehat dissipation the most common 
sns.countplot(x= machine.loc[machine['Failure'] == 1]['Failure Type'])
plt.xticks(fontsize = 6)
plt.show()
print(machine.loc[machine['Failure'] == 1]['Failure Type'].value_counts())

# %%
sns.countplot(x= machine.loc[machine['Failure'] == 1]['Failure Type'], hue= machine['Machine Type'])
plt.xticks(fontsize = 6)
plt.show()
print(machine.loc[machine['Failure'] == 1][['Machine Type', 'Failure Type']].value_counts().sort_index())

# %%
# Looking broadly at correlation between variables with legend as failure to see if can spot any trends
# Can see quite a clear grouping of failures at higher rotational speeds, and also higher air temperatures
# Tool wear also looks to have quite a clear grouping of failures at higher values

#Looks like we have some correlation between air temp and process temp, and also rotational speed and torque
sns.pairplot(machine, hue = 'Failure')

# %%
sns.pairplot(machine2, hue = 'Power Failure')

# %%
# Same plot but now only for failures
# Interesting to see breakdown of which failures occur - goves good idea for closer look 
machinefail = machine.loc[machine['Failure'] == 1]

sns.pairplot(machinefail, hue = 'Failure Type')

# %%
#Heatmap for correlations
# Heatmap shows mild positive correlation between the temperature variables and a mild negative between rotational speed and torque
# Neither correlations large enough to worry about causing multicollinearity in ML build

plt.figure(figsize=(20,20))
sns.heatmap(machine.drop(columns = ['UID','Timestamp', 'Date', 'Time', 'Failure Type', 'Machine Type']).corr(), annot=True)
plt.show()

# %%
# creating dummy variables for machine type and failure

machinetype = pd.get_dummies(machine['Machine Type']).astype(dtype=int)
failuretype = pd.get_dummies(machine['Failure Type']).astype(dtype=int)

machine2 = pd.concat([machine, machinetype, failuretype], axis=1)

# %%
machine2 = machine2.drop(columns = ['Machine Type', 'Failure Type'])

# %%
machine2

# %%
machine2.drop(columns = ['UID','Timestamp', 'Date', 'Time']).corr()

# %%
plt.figure(figsize=(25,25))
sns.heatmap(machine2.drop(columns = ['UID','Timestamp', 'Date', 'Time']).corr(), annot = True)
plt.show()

# %%
machine['Timestamp'] = pd.to_datetime(machine['Timestamp'])

# %%
failure_colors = {
    "Power Failure": "#1f77b4",         
    "Tool Wear Failure": "#ff7f0e",      
    "Overstrain Failure": "#2ca02c",     
    "Random Failures": "#d62728",       
    "Heat Dissipation Failure": "#9467bd" 
}

# %%
# Only looking at failures
# Start off with Air temperature
# Can see quite clealy that above 300 kelvin is where majority of heat dissipation failures occur
#Also all grouped in middle of dataset whih would be summer months - makes sense with higher air temperature

machinefail = machine.loc[machine['Failure'] == 1]
plt.figure(figsize=(15,10))
sns.scatterplot(x = machinefail['Timestamp'], y = machinefail['Air temperature [K]'], hue = machinefail['Failure Type'],  palette=failure_colors)
plt.show()

# %%
# Boxplot shows that basically all heat dissipation failures occur between around 202 and 303 kelvin. 
# This is pretty much the nly failure that occurs at this temperature consistently 
# Looks like if client keeps air temperature below 300 then number f heat dissipation failures could be greatly decreased 

plt.figure(figsize=(15,10))
sns.boxplot(x = machine['Failure Type'], y = machine['Air temperature [K]'])
plt.xticks(fontsize =6)
plt.show()

# %%
# Plotting these heat disspation failures agaiinst air temperature
# Again more illustration that air temperature over 300 kelvin is correlated with greatly increasing number of heat dissipation failures

heatfailure = machine.loc[machine['Failure Type'] == 'Heat Dissipation Failure']

sns.histplot(x = heatfailure['Air temperature [K]'], kde= True)

# %%
machine2.info()

machine2["Timestamp"] = pd.to_datetime(machine2["Timestamp"])


# %%
heatfailure['Timestamp'] = pd.to_datetime(heatfailure['Timestamp'])
heatfailure['monthname'] = heatfailure["Timestamp"].dt.month_name()



# %%
# Trying to visualise this with months on x axis to see if summer months are in fact where majority of these failures occur
# Using dataframe created earlier to look at large correlation plot
# Can clearly see the grouping in summer months of 2002 which makes sense with warmer temperatures
# Heatfailures only occur in April, May and June
sns.countplot(x = heatfailure['monthname'])


# %%
# Just another illustration of peak in summer months 
# Advice to client will be to maintain temperature below 300 kelvin to avoid heat dissipation failures
machine4 = machine.loc[machine['Failure'] == 1]
machine4['Timestamp'] = pd.to_datetime(machine4['Timestamp'])
machine4['monthname'] = machine4["Timestamp"].dt.month_name()
plt.figure(figsize=(15,10))
sns.countplot(x = machine4['monthname'], hue = machine4['Failure Type'])
plt.xticks(fontsize = 4)
plt.show()


# %%
np.mean(machine['Air temperature [K]'])

# %%
# Moving on to looking at rotational speed as observed a lot of failures at higher values of this 
# Visually looks quite clear that alot of power failures occur at high instances of rotational speed and also at lower
# There appears to be a sweet spot where no power failure occurs
# Early hypothesis would be if client can maintain speed inbetween certain speeds then can eradicate alot of power failures

machinefail = machine.loc[machine['Failure'] == 1]
plt.figure(figsize=(15,10))
sns.scatterplot(x = machinefail['Timestamp'], y = machinefail['Rotational speed [rpm]'], hue = machinefail['Failure Type'],  palette=failure_colors)
plt.show()

# %%
plt.figure(figsize=(15,10))
sns.boxplot(x = machine['Failure Type'], y = machine['Rotational speed [rpm]'])
plt.xticks(fontsize =6)
plt.show()

# %%
# Plotting histogram 
# Quite clear illustration of swet spot where very few power failures occur 
# Plotting beside histogram for rotational speed - looks plausible for machine to operate from 1500 up to 2000


powerfailure = machine.loc[machine['Failure Type'] == 'Power Failure']
plt.figure(figsize=(15,5))
plt.subplot(1,2,1)
sns.histplot(x = powerfailure['Rotational speed [rpm]'], kde= True)
plt.subplot(1,2,2)
sns.histplot(x = machine['Rotational speed [rpm]'], kde = True)
plt.show()

# %%
plt.figure(figsize=(15,5))
plt.subplot(1,2,1)
sns.histplot(x = machine2['Rotational speed [rpm]'], hue = machine2['Power Failure'])
plt.subplot(1,2,2)
sns.histplot(x = machine['Rotational speed [rpm]'], hue = machine['Failure'])

# %%
# Plotting to see tool wear as observed correlation with higher values of tool wear and failures
# Can see tool wear failures only occur > around 190 
# Same with overstrain failures but maybe closer to 180 for these
machinefail = machine.loc[machine['Failure'] == 1]
plt.figure(figsize=(15,10))
sns.scatterplot(x = machinefail['Timestamp'], y = machinefail['Tool wear [min]'], hue = machinefail['Failure Type'],  palette=failure_colors)
plt.show()

# %%
# Maintaining tool wear < 190 will greatly reduce number of tool wear failures

plt.figure(figsize=(15,5))
plt.subplot(1,2,1)
sns.histplot(x = machine2['Tool wear [min]'], hue = machine2['Tool Wear Failure'])
plt.subplot(1,2,2)
sns.histplot(x = machine['Tool wear [min]'], hue = machine['Failure'])


# %%
# High tool wear looks to be correlated with both overstrain and tool wear failures

plt.figure(figsize=(15,5))
plt.subplot(1,2,1)
sns.histplot(x = machine2['Tool wear [min]'], hue = machine2['Overstrain Failure'])
plt.subplot(1,2,2)
sns.histplot(x = machine['Tool wear [min]'], hue = machine['Failure'])

# %%
plt.figure(figsize=(15,10))
sns.boxplot(x = machine['Failure Type'], y = machine['Tool wear [min]'])
plt.xticks(fontsize =6)
plt.show()

# %%
# Would be interesting to see how rotational speed and tool wear move together with failures
# Clear reccomendation to client to keep toolwear below around 170 to avoid overtrain and tool wear failures
plt.figure(figsize=(15,5))
plt.subplot(1,2,1)
sns.scatterplot(x = machine['Tool wear [min]'], y = machine['Rotational speed [rpm]'], hue = machine['Failure Type'])
plt.subplot(1,2,2)
sns.scatterplot(x=machinefail['Tool wear [min]'], y = machinefail['Rotational speed [rpm]'], hue = machinefail['Failure Type'])
plt.show()

# %%
# Nothing as clear can be taken from torque
plt.figure(figsize=(15,10))
sns.boxplot(x = machine['Failure Type'], y = machine['Torque [Nm]'])
plt.xticks(fontsize =6)
plt.show()

# %%
plt.figure(figsize=(15,10))
sns.scatterplot(x = machine['Timestamp'], y = machine['Torque [Nm]'], hue = machine['Failure Type'])
plt.show()

# %%
# Not much can be taken from process temperature
machinefail = machine.loc[machine['Failure'] == 1]
plt.figure(figsize=(15,10))
sns.scatterplot(x = machinefail['Timestamp'], y = machinefail['Process temperature [K]'], hue = machinefail['Failure Type'],  palette=failure_colors)
plt.show()

# %%
# EDA concluded and ready to move on to machine learning
# Clear recommendations can be made from eda alone 
# Maintain air temperature below 300 kelvin, maintain rotational speed between 1500 and 2000 as much as possible
# Maintain tool wear below 170


